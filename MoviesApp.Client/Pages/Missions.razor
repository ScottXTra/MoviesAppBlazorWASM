@page "/missions"
@using MoviesApp.Client.Services
@using MoviesApp.Shared.DTOs
@inject MissionService MissionService
@inject IJSRuntime JSRuntime
@using Microsoft.AspNetCore.SignalR.Client

<PageTitle>Missions</PageTitle>

<div class="container">
    <div class="form_area">
        <h1 class="title">Missions</h1>
        <div class="missions-controls">
        <div class="dispatch-section">
            <h5>Manually Dispatch Missions</h5>
            <select class="form-select mb-2" @bind="selectedFleet">
                <option value="">Select fleet</option>
            </select>
            <button class="btn btn-primary" @onclick="DispatchMission">Dispatch Mission</button>
        </div>
        <div class="cancel-section">
            <h5>Cancel Missions</h5>
            <select class="form-select mb-2" @bind="selectedMissionId">
                <option value="">Select mission</option>
                @foreach (var mission in missions)
                {
                    <option value="@mission.Id">@mission.Name</option>
                }
            </select>
            <button class="btn btn-danger" @onclick="ShowCancelDialog" disabled="@(selectedMissionId == null)">Cancel Mission</button>
        </div>
        <div class="date-filter">
            <label>From:</label>
            <input type="date" class="form-control" @bind="fromDate" />
            <label>To:</label>
            <input type="date" class="form-control" @bind="toDate" />
        </div>
    </div>

    <table class="missions-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Status</th>
                <th>Created</th>
                <th>Assigned Robot</th>
                <th>Description</th>
                <th>Mission Type</th>
            </tr>
        </thead>
        <tbody>
            @if (isLoading)
            {
                <tr><td colspan="7" class="text-center">Loading...</td></tr>
            }
            else if (missions.Any())
            {
                foreach (var mission in missions)
                {
                    <tr>
                        <td>@mission.Id</td>
                        <td>@mission.Name</td>
                        <td>@mission.Status</td>
                        <td>@mission.LaunchDate.ToString("MMM dd, yyyy")</td>
                        <td>--</td>
                        <td>@mission.Destination</td>
                        <td>--</td>
                    </tr>
                }
            }
            else
            {
                <tr><td colspan="7" class="text-center">No missions found</td></tr>
            }
        </tbody>
    </table>

    <div class="history-toggle">
        <input type="checkbox" id="viewHistorical" @bind="viewHistorical" />
        <label for="viewHistorical">View historical missions</label>
    </div>
    </div>
</div>

@if (showCancelConfirm)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <h4>Warning!</h4>
            <p>Are you sure you want to cancel the following mission?</p>
            <p>@selectedMissionName</p>
            <div class="modal-actions">
                <button class="btn btn-warning" @onclick="ConfirmCancel">Yes, cancel</button>
                <button class="btn btn-secondary" @onclick="() => showCancelConfirm = false">No, don't cancel</button>
            </div>
        </div>
    </div>
}

@code {
    private List<MissionDto> missions = new();
    private bool isLoading = true;
    private HubConnection? _hubConnection;

    private string? selectedFleet;
    private int? selectedMissionId;
    private string? selectedMissionName;
    private DateTime? fromDate;
    private DateTime? toDate;
    private bool viewHistorical;
    private bool showCancelConfirm;

    protected override async Task OnInitializedAsync()
    {
        await LoadMissions();

        _hubConnection = new HubConnectionBuilder()
            .WithUrl("https://localhost:7003/missionhub")
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<MissionDto>("MissionUpdated", (updatedMission) =>
        {
            var index = missions.FindIndex(m => m.Id == updatedMission.Id);
            if (index != -1)
            {
                missions[index] = updatedMission;
            }
            StateHasChanged();
        });

        _hubConnection.On<MissionDto>("MissionCreated", (newMission) =>
        {
            missions.Add(newMission);
            StateHasChanged();
        });

        _hubConnection.On<int>("MissionDeleted", (deletedId) =>
        {
            var mission = missions.FirstOrDefault(m => m.Id == deletedId);
            if (mission != null)
            {
                missions.Remove(mission);
                StateHasChanged();
            }
        });

        await _hubConnection.StartAsync();
    }

    private async Task LoadMissions()
    {
        isLoading = true;
        missions = await MissionService.GetMissionsAsync();
        isLoading = false;
    }

    private void DispatchMission()
    {
        // Placeholder for dispatch logic
    }

    private void ShowCancelDialog()
    {
        var mission = missions.FirstOrDefault(m => m.Id == selectedMissionId);
        selectedMissionName = mission?.Name;
        showCancelConfirm = true;
    }

    private void ConfirmCancel()
    {
        // Placeholder for cancel logic
        showCancelConfirm = false;
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
            await _hubConnection.DisposeAsync();
    }
}
